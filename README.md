# top-k-distributed

Комбинация двух алгоритмов: 
1) TPUT - распределенный алгоритм для точного подсчета top-k, основанный на нескольких фазах общения между центральным и дочерними нодами, которые непосредственно предоставляют API. Есть различные улучшения, которые позволяют убрать точку отказа и bottleneck в виде одного сервера (такие как hierarchical 4RUT), но поскольку я работал с PHP очень мало, и такое решение потребует нетрививиальной логике по обнаружению и балансировке несольких серверов, я отказался от него (выходит за рамки задания и по объему, и по фреймворкам). 
Таким образом сейчас каждый application server должен синхронизироваться самостоятельно с базой, а значит нужны либо транзакции, либо локи.

2) StreamSummary для локального приближенного подсчета top-k. Замечателен тем, что позволяет гарантировать top-k для естественных текстов при почти константных (O(k)) затратах на память. Нашел изначально его, дописал функциональность по объединению нескольких таких структур (если у нас все же несколько app серверов), сохранению и выгрузке из базы. 
Поскольку это по сути мапа + список списков с указателями, в реляционной базе хранить не удобно, без локов обновлять тем более. К тому же хотелось что-то очень быстрое в плане получения и сохранения в базу (если много серверов).
Итого локально используем StreamSummary в течении искомого таймфрейма (в нашем случае 5 минут), после чего начинаем по одному мержить с сохранненым StreamSummary в базе. Поскольку размер структуры ограничен, можно зная число серверов и скорость обработки\передачи данных сказать за какое время мы сможем обработать весь объем накопленных за 5 минут данных.
В итоге я выбрал redis, который оказался достаточно удобен (есть локи, мапы, быстро работает т.к. in-memory). Дописать сохранение из него результатов в любую другую базу не должно представлять проблем.

StreamSummary: Efficient Computation of Frequent and Top-k Elements in Data Streams, by Metwally, Agrawal, and Abbad, 2005

TPUT: Efficient Top-K Query Calculation in Distributed Networks, by Pei Cao and Zhe Wang, 2004 
